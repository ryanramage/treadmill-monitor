<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Heart Rate Monitor</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Heart rate training app for treadmill workouts with Bluetooth connectivity">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HR Training">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#007bff">
    
    <link rel="stylesheet" href="css/overlay.css" />
    <link rel="stylesheet" href="css/monitor.css" />
</head>
<body>
    <div class="container">
        <!-- Workout Builder Section -->
        <div id="workoutBuilder" class="workout-builder">
            <h2>Workout Builder</h2>
            <div class="workout-controls">
                <input type="text" id="workoutName" placeholder="Workout Name" />
                <button id="saveWorkout">Save</button>
                <select id="savedWorkouts">
                    <option value="">Select saved workout...</option>
                </select>
                <button id="loadWorkout">Load</button>
                <button id="deleteWorkout">Delete</button>
                <input type="file" id="jsonFileInput" accept=".json" style="display: none;" />
                <button id="importJson">Import JSON File</button>
                <button id="importJsonPaste">Paste JSON</button>
            </div>
            
            <div class="segment-builder">
                <h3>Add Segment</h3>
                
                <!-- Duration -->
                <input type="number" id="segmentDuration" placeholder="Duration (minutes)" step="0.1" min="0" />
                
                <!-- Training Mode Toggle -->
                <div class="training-mode">
                    <label>
                        <input type="radio" name="trainingMode" value="heartRate" checked> Heart Rate Target
                    </label>
                    <label>
                        <input type="radio" name="trainingMode" value="manual"> Manual Control
                    </label>
                </div>
                
                <!-- Heart Rate Mode -->
                <div id="heartRateMode" class="mode-section">
                    <input type="number" id="targetHeartRate" placeholder="Target HR (bpm)" min="50" max="220" />
                    <div class="adjustment-strategy">
                        <label>Adjust:</label>
                        <label><input type="checkbox" name="adjustSpeed" checked> Speed</label>
                        <label><input type="checkbox" name="adjustIncline"> Incline</label>
                    </div>
                    <div class="speed-limits">
                        <input type="number" id="minSpeed" placeholder="Min Speed" step="0.1" />
                        <input type="number" id="maxSpeed" placeholder="Max Speed" step="0.1" />
                        <select id="speedLimitsUnit">
                            <option value="kmh">km/h</option>
                            <option value="minperkm">min/km</option>
                        </select>
                    </div>
                </div>
                
                <!-- Manual Mode -->
                <div id="manualMode" class="mode-section" style="display: none;">
                    <div class="speed-input">
                        <input type="number" id="manualSpeed" placeholder="Speed" step="0.1" />
                        <select id="speedUnit">
                            <option value="kmh">km/h</option>
                            <option value="minperkm">min/km</option>
                        </select>
                    </div>
                    <input type="number" id="manualIncline" placeholder="Incline %" step="0.1" />
                </div>
                
                <button id="addSegment">Add Segment</button>
            </div>
            
            <div class="segments-list">
                <h3>Workout Segments</h3>
                <div id="segmentsList"></div>
            </div>
            
            <div class="connection-section">
                <h3>Treadmill Connection</h3>
                <div class="connection-controls">
                    <button id="toggleConnectionBuilder">Connect</button>
                    <span id="connectionStatus" class="connection-status disconnected">Not connected</span>
                </div>
            </div>
            
            <button id="startWorkout" class="start-button">Start Workout</button>
        </div>

        <!-- JSON Paste Modal (hidden initially) -->
        <div id="jsonPasteModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Import JSON Workout</h3>
                    <button id="closeJsonModal" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <textarea id="jsonPasteArea" placeholder="Paste your JSON workout here..." rows="15"></textarea>
                    <div class="modal-actions">
                        <button id="importPastedJson" class="import-btn">Import</button>
                        <button id="cancelJsonImport" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post-Workout Screen (hidden initially) -->
        <div id="postWorkoutScreen" class="post-workout-screen" style="display: none;">
            <h2>Workout Complete! üéâ</h2>
            
            <div class="workout-summary">
                <div class="summary-header">
                    <h3>Workout Summary</h3>
                    <div class="workout-datetime">
                        <span id="workoutDate"></span> at <span id="workoutTime"></span>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Duration</div>
                        <div class="summary-value" id="summaryDuration">--:--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Distance</div>
                        <div class="summary-value" id="summaryDistance">-- km</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg Speed</div>
                        <div class="summary-value" id="summaryAvgSpeed">-- km/h</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Max Speed</div>
                        <div class="summary-value" id="summaryMaxSpeed">-- km/h</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg Heart Rate</div>
                        <div class="summary-value" id="summaryAvgHR">-- bpm</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Max Heart Rate</div>
                        <div class="summary-value" id="summaryMaxHR">-- bpm</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Calories</div>
                        <div class="summary-value" id="summaryCalories">-- kcal</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg Incline</div>
                        <div class="summary-value" id="summaryAvgIncline">--%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Max Incline</div>
                        <div class="summary-value" id="summaryMaxIncline">--%</div>
                    </div>
                </div>
            </div>
            
            <div class="export-section">
                <h3>Export Workout</h3>
                <div class="export-buttons">
                    <button id="exportGarmin" class="export-btn garmin-btn">
                        üì± Export for Garmin Connect
                        <small>Download TCX file</small>
                    </button>
                    <button id="exportJson" class="export-btn json-btn">
                        üìÑ Export Raw Data
                        <small>Download JSON file</small>
                    </button>
                </div>
                <div class="export-info">
                    <p><strong>Garmin Connect:</strong> Upload the TCX file to Garmin Connect as a treadmill activity</p>
                    <p><strong>Raw Data:</strong> Complete workout data including all segments and measurements</p>
                </div>
            </div>
            
            <div class="post-workout-actions">
                <button id="newWorkout" class="action-btn primary">Start New Workout</button>
            </div>
        </div>

        <!-- Running Interface (hidden initially) -->
        <div id="runningInterface" class="running-interface" style="display: none;">
            <div class="running-header">
                <div class="workout-title">
                    <h2>Workout in Progress</h2>
                    <div class="device-status">
                        <span id="device-name">Device: Not connected</span>
                        <div class="control-mode-section">
                            <span id="controlMode" class="control-mode auto">ü§ñ Program Control</span>
                            <button id="resumeProgramControl" style="display: none;">Resume Program</button>
                        </div>
                    </div>
                </div>
                
                <div class="workout-controls">
                    <button id="toggleConnection" class="control-btn secondary">Connect</button>
                    <button id="pauseWorkout" class="control-btn warning">Pause</button>
                    <button id="stopWorkout" class="control-btn danger">Stop</button>
                </div>
            </div>

            <!-- Main Speed Display -->
            <div class="speed-display">
                <div class="current-speed">
                    <span class="speed-value" id="currentSpeed">--</span>
                    <span class="speed-unit">km/h</span>
                </div>
                <div class="target-info">
                    <span id="targetSpeed">Target: -- km/h</span>
                </div>
            </div>

            <!-- Workout Progress Section -->
            <div class="workout-progress">
                <div class="segment-header">
                    <div class="segment-info">
                        <span id="currentSegmentInfo" class="segment-title">Segment 1/5</span>
                        <span id="segmentTimeRemaining" class="time-remaining">5:30 remaining</span>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar-large">
                        <div id="segmentProgress" class="progress-fill-large"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-start">Start</span>
                        <span class="progress-end">End</span>
                    </div>
                </div>
            </div>

            <!-- Data Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card primary">
                    <div class="metric-icon">üèÉ</div>
                    <div class="metric-content">
                        <div class="metric-label">Distance</div>
                        <div class="metric-value" id="distance">-- km</div>
                    </div>
                </div>
                
                <div class="metric-card secondary">
                    <div class="metric-icon">‚è±Ô∏è</div>
                    <div class="metric-content">
                        <div class="metric-label">Duration</div>
                        <div class="metric-value" id="duration">--:--:--</div>
                    </div>
                </div>
                
                <div class="metric-card accent">
                    <div class="metric-icon">‚ù§Ô∏è</div>
                    <div class="metric-content">
                        <div class="metric-label">Heart Rate</div>
                        <div class="metric-value" id="current-heart-rate">-- bpm</div>
                    </div>
                </div>
                
                <div class="metric-card info">
                    <div class="metric-icon">üî•</div>
                    <div class="metric-content">
                        <div class="metric-label">Calories</div>
                        <div class="metric-value" id="calories">-- kcal</div>
                    </div>
                </div>
                
                <div class="metric-card warning">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-content">
                        <div class="metric-label">Incline</div>
                        <div class="metric-value" id="incline">-- %</div>
                    </div>
                </div>
                
                <div class="metric-card neutral">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-content">
                        <div class="metric-label">Pace</div>
                        <div class="metric-value" id="speed">-- min/km</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/hr-training.js"></script>
    
    <!-- PWA Installation and Service Worker -->
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = 'Install App';
        installButton.className = 'install-button';
        installButton.style.display = 'none';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });

        // Add install button to the page
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.container');
            if (container) {
                container.appendChild(installButton);
            }
        });

        // Handle app installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.style.display = 'none';
        });

        // Prevent zoom on double tap (iOS)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });
    </script>
</body>
</html>
